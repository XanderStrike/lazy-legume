<% if notice %>
  <%= bootstrap_alert(:success, notice).html_safe %>
<% end %>

<span class="pull-right">
  <%= link_to 'Destroy', @show, method: :delete, data: { confirm: 'Are you sure? This will delete all associated episodes and rules (but not files on the disk).' } %> |
  <%= link_to 'Shows', shows_path %> |
  <%= link_to 'Home', root_url %>
</span>
<br>
<%= render partial: 'show_info', locals: { show: @show } %>

<h4>Rules</h4>
<div id="js-rules-area">
  <%= render partial: 'rules/rules_list', locals: { show: @show } %>
</div>
<%= link_to 'Add Rule', new_rule_path(show: @show.id), class: 'btn btn-inverse', remote: true %>

<br>
<br>

<h4>Episodes</h4>
<%= render partial: 'episode_table', locals: { episodes: @episodes } %>



<% content_for :javascript do %>
  <script>
    function tokenizeStr(str) {
      return str.toLowerCase().split(/\W/).filter(function(v){return v!==''}).join('.*');
    }

    function regexTitle() {
      return tokenizeStr($('.js-show-title').text());
    }

    function buildRegexForRule(form_id) {
      var regex_field = $(form_id + ' #rule_regex');

      var keywords = $(form_id + ' #rule_keywords').val();
      var quality = $(form_id + ' #rule_quality').val();

      var regex = '';

      (keywords != '') && (regex += tokenizeStr(keywords));
      (quality != '') && (regex += '.*' + quality);

      regex_field.val(regex);
    }

    function attachChangeHandlers(form_id) {
      $(form_id + ' #rule_keywords').keyup(function () {
        buildRegexForRule(form_id);
      });
      $(form_id + ' #rule_quality').change(function () {
        buildRegexForRule(form_id);
      });

      $(form_id + ' #rule_regex').click(function() {
        $(this).removeAttr('readonly');
      })
    }

    function initialize() {
      $('.edit_rule').map(function() {
        attachChangeHandlers('#' + this.id);
      });
    }

    $(document).ready(initialize);
  </script>
<% end %>
